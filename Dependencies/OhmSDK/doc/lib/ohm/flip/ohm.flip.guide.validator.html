<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Flip Programming Guide: Writing a DocumentValidator</title>
<link rel="stylesheet" href="docpage.css" type="text/css" />
</head>

<script type="text/javascript">
function searchfield_focus(obj)
{
obj.style.color="#000"
if (obj.value=="Search Library")
	{obj.value=""}
}
</script>


<body>

<div id="header">
<div style="width: 1006px;">
<!--<form method="get" class="search" style="padding-top: 5px;"  action="http://www.google.com/search">
<input onfocus="searchfield_focus(this)" type="search" class="search" name="q" value="Search Library">
<input type="hidden" name="sitesearch" value="">
</form>-->
</div>
<p><a href="index.html">Ohm Force Developer Library</a><a href="ohm.flip.guide.about.html">Flip Programming Guide</a></p>
</div>

<div id="toc">
<p>Flip Programming Guide</p>
<ul>
<li><a href="ohm.flip.guide.about.html">About Flip Programming Guide</a></li>
<li><a href="ohm.flip.guide.design.html">Designing your Flip Application</a></li>
<li><a href="ohm.flip.guide.class.html">Writing a Flip Class Part 1</a></li>
<li><a href="ohm.flip.guide.class2.html">Writing a Flip Class Part 2</a></li>
<li><a href="ohm.flip.guide.containers.html">Using Containers</a></li>
<li><a href="ohm.flip.guide.enums.html">Using Enums</a></li>
<li><a href="ohm.flip.guide.blob.html">Using Blobs</a></li>
<li><a href="ohm.flip.guide.objectref.html">Using ObjectRefs</a></li>
<li><a href="ohm.flip.guide.cue.html">Using Cues</a></li>
<li><a href="ohm.flip.guide.navigation.html">Navigating the Model</a></li>
<li><a href="ohm.flip.guide.observer.html">Writing a DocumentObserver</a></li>
<li><a href="ohm.flip.guide.validator.html"><strong>Writing a DocumentValidator</strong></a>
	<ul>
	<li><a href="ohm.flip.guide.validator.html#overview">Overview</a></li>
	<li><a href="ohm.flip.guide.validator.html#setup">Setting Up</a></li>
	<li><a href="ohm.flip.guide.validator.html#parsing">Parsing the Model Tree</a></li>
	<li><a href="ohm.flip.guide.validator.html#validating">Validating the Model Tree</a></li>
	</ul>
</li>
<li><a href="ohm.flip.guide.undo.html">Using the Undo/Redo system</a></li>
<li><a href="ohm.flip.guide.const.html">Managing Pseudo Const Members</a></li>
<li><a href="ohm.flip.guide.mold.html">Using an ObjectMold</a></li>
<li><a href="ohm.flip.guide.conversion.html">Writing a Converter</a></li>
<li><a href="ohm.flip.guide.tweaker.html">Writing a DocumentTweaker</a></li>
</ul>

<div class="bottomspacer">&nbsp;</div>
</div>

<div id="content">

<div class="nav" align="right"><a href="ohm.flip.guide.observer.html">previous</a><span>&nbsp;</span><a href="ohm.flip.guide.undo.html">next</a></div>

<h1>Writing a DocumentValidator</h1>

<p>This chapter will describe the use of
<span class="code">flip::DocumentValidator</span> 
with the Flip framework.</p>
<h2><a name="overview">Overview</a></h2>
<p>The Flip framework offers a
<span class="code">flip::DocumentValidator</span> 
template class
which is the basis to write a document validator. A document validator
receives model changes and perform logical validation.</p>
<p>Logical validation follows the structural validation handled by the Flip
framework and will dynamically ensure that the model is in a consistent
state. When the logical validation is running on the server side, it will
accept or refuse a transaction. When a transaction is accepted, it will
be broadcasted to the other clients and the originator will receive a
notification that its transaction was accepted. When a transaction is
refused, it is rollbacked on the server side, and a notification is sent
to the originator for him to rollback the transaction as well.</p>
<p>By convention, the document validator source file will reside with the other
model files.</p>
<p>In the following, it will be assumed that the model has the format listed
in the listings below. In particular,
<span class="code">Root</span> 
will be the root class
of the model. The listings skip all functions just to show the needed members
for clarity.</p>
<p>The example is an hypothetic taxi company, where the taxis can change of color.
The taxi company has a boss, which can be happy or upset. The taxi company
also maintains the total number of courses since the beginning of time.</p>
<div class="codeblock">
<table>
<tr><td><pre>class Boss</pre></td></tr>
<tr><td><pre>:  public ohm::flip::Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   bool                 did_happyness_change () const;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>private:</pre></td></tr>
<tr><td><pre>   ohm::flip::Bool      _happy_flag;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>class Taxi</pre></td></tr>
<tr><td><pre>:  public ohm::flip::Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>   bool                 did_color_change () const;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>private:</pre></td></tr>
<tr><td><pre>   ohm::flip::Int64     _color;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>typedef ohm::flip::Collection &lt;Taxi&gt;   TaxiColl;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>class Root</pre></td></tr>
<tr><td><pre>:  public ohm::flip::Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>private:</pre></td></tr>
<tr><td><pre>   ohm::flip::Int64     _nbr_taxi_course;</pre></td></tr>
<tr><td><pre>   Boss                 _boss;</pre></td></tr>
<tr><td><pre>   TaxiColl             _taxi_coll;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
</table>
</div>
<h2><a name="setup">Setting Up</a></h2>
<p>To set up the validator, we have to make a
<span class="code">DocumentValidator</span> 
for the
<span class="code">Root</span> 
class. For that we make a class that inherits from
<span class="code">ohm::flip::DocumentValidator</span> 
which template parameter is
<span class="code">Root</span> 
.</p>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">DocumentValidator</span> 
declaration
</p>
<table>
<tr><td><pre>class DocumentValidator</pre></td></tr>
<tr><td><pre>:  public ohm::flip::DocumentValidator &lt;Root&gt;</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>public:</pre></td></tr>
<tr><td><pre>                  DocumentValidator ();</pre></td></tr>
<tr><td><pre>   virtual        ~DocumentValidator () {}</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   // inherited from ohm::flip::DocumentValidator &lt;model::Root&gt;</pre></td></tr>
<tr><td><pre>   virtual void   validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Root & root);</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
</table>
</div>
<p>Then the client will bind the validator to the Flip
<span class="code">ohm::flip::DocumentServer</span> 
. At this
point any model change to the document will be notified through the
<span class="code">validate</span> 
<span class="code">virtual</span> 
method.</p>
<h2><a name="parsing">Parsing the Model Tree</a></h2>
<p>Parsing the model tree itself is done in the exact same way as for the
<span class="code">DocumentObserver</span> 
.</p>
<p>Before we put write the implementation of
<span class="code">validate</span> 
we are going
to add some
<span class="code">private</span> 
methods to keep the code clean</p>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">DocumentObserver</span> 
declaration
</p>
<table>
<tr><td><small><pre>class DocumentValidator</pre></small></td></tr>
<tr><td><small><pre>:  public ohm::flip::DocumentValidator &lt;Root&gt;</pre></small></td></tr>
<tr><td><small><pre>{</pre></small></td></tr>
<tr><td><small><pre>public:</pre></small></td></tr>
<tr><td><small><pre>                  DocumentValidator ();</pre></small></td></tr>
<tr><td><small><pre>   virtual        ~DocumentValidator () {}</pre></small></td></tr>
<tr><td><small><pre></pre></small></td></tr>
<tr><td><small><pre>   // inherited from ohm::flip::DocumentValidator &lt;model::Root&gt;</pre></small></td></tr>
<tr><td><strong><pre>   virtual void   validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Root & root);</pre></strong></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><strong><pre>private:</pre></strong></td></tr>
<tr><td><strong><pre>   void           validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Boss & boss);</pre></strong></td></tr>
<tr><td><strong><pre>   void           validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Taxi & taxi);</pre></strong></td></tr>
<tr><td><small><pre>}</pre></small></td></tr>
</table>
</div>
<p>The code to handle each class is always to check changes for its direct basic typed members.
To keep the code clean, each compound object should have its own
<span class="code">validate</span> 
method as illutrated here.</p>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">validate (Root &)</span> 
definition
</p>
<table>
<tr><td><pre>void  DocumentObserver::validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Root & root)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   if (root.did_nbr_taxi_course_change ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      // validate the number of taxi course</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (_boss.is_invalid ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      // _boss contains a modification</pre></td></tr>
<tr><td><pre>      validate (_boss);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (_taxi_coll.is_invalid ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      // the taxi collection contains a modification, check every taxi</pre></td></tr>
<tr><td><pre>      TaxiColl::iterator it = _taxi_coll.begin ();</pre></td></tr>
<tr><td><pre>      const TaxiColl::iterator it_end = _taxi_coll.end ();</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      for (; it != it_end ; ++it)</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         Taxi & taxi = *it;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>         if (taxi.is_invalid ())</pre></td></tr>
<tr><td><pre>         {</pre></td></tr>
<tr><td><pre>            validate (taxi);</pre></td></tr>
<tr><td><pre>         }</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<div class="note"><p><strong>Note:</strong>In theory, every call to
<span class="code">is_invalid</span> 
can be omited. But this is done for speed.</p></div>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">validate (Boss &)</span> 
definition
</p>
<table>
<tr><td><pre>void  DocumentObserver::validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Boss & boss)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   // nothing to validate</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">validate (Taxi &)</span> 
definition
</p>
<table>
<tr><td><pre>void  DocumentObserver::validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Taxi & taxi)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   if (taxi.did_color_change ())</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      // validate the new taxi color</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<h2><a name="validating">Validating the Model Tree</a></h2>
<p>A model tree is considered as validated if the document validator did not issue
any error during the model tree parsing. In particular, the model tree is
considered as not validated as soon as one error is reported.</p>
<p>Reporting errors is made through the
<span class="code">ValidationReportWriter & report</span> 
method parameter.</p>
<p>Here we are going to consider that validating the
<span class="code">Taxi</span> 
color is to ensure
that the color number shoult be between
<span class="code">0</span> 
and
<span class="code">6</span> 
(note that we
should have maybe use an
<span class="code">Enum</span> 
to do this, as the bound check would have
been done in the Flip structural validation)</p>
<div class="codeblock">
<p><strong>Listing</strong><span class="code">validate (Taxi &)</span> 
definition, continued
</p>
<table>
<tr><td><small><pre>void  DocumentObserver::validate (flip::ValidationReportWriter & report, archi::Int32 user_id, Taxi & taxi)</pre></small></td></tr>
<tr><td><small><pre>{</pre></small></td></tr>
<tr><td><small><pre>   if (taxi.did_color_change ())</pre></small></td></tr>
<tr><td><small><pre>   {</pre></small></td></tr>
<tr><td><strong><pre>      archi::Int64 color = taxi.get_color ();</pre></strong></td></tr>
<tr><td><strong><pre></pre></strong></td></tr>
<tr><td><strong><pre>      if ((color &lt; 0) || (color &gt; 6))</pre></strong></td></tr>
<tr><td><strong><pre>      {</pre></strong></td></tr>
<tr><td><strong><pre>         // this is an error, report</pre></strong></td></tr>
<tr><td><strong><pre></pre></strong></td></tr>
<tr><td><strong><pre>         report.print_logical_error ("Taxi: _color out of bound (%1%)").arg (color);</pre></strong></td></tr>
<tr><td><strong><pre>      }</pre></strong></td></tr>
<tr><td><small><pre>   }</pre></small></td></tr>
<tr><td><small><pre>}</pre></small></td></tr>
</table>
</div>
<p>The report supports formatted strings. See
<a href="ohm.flip.reference.validwriter.html">Flip Reference: ValidationReportWriter Class Reference</a>
for more informations.</p>


<div class="nav" align="right"><a href="ohm.flip.guide.observer.html">previous</a><span>&nbsp;</span><a href="ohm.flip.guide.undo.html">next</a></div>

<div class="bottomspacer">&nbsp;</div>

</div>

<footer>
<a href="index.html">Ohm Force Developer Library</a> > <a href="ohm.flip.guide.about.html">Flip Programming Guide</a> > <a href="ohm.flip.guide.validator.html">Writing a DocumentValidator</a>
</footer>


</body>

</html>