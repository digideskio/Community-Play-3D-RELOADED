<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Flip Programming Guide: Writing a Converter</title>
<link rel="stylesheet" href="docpage.css" type="text/css" />
</head>

<script type="text/javascript">
function searchfield_focus(obj)
{
obj.style.color="#000"
if (obj.value=="Search Library")
	{obj.value=""}
}
</script>


<body>

<div id="header">
<div style="width: 1006px;">
<!--<form method="get" class="search" style="padding-top: 5px;"  action="http://www.google.com/search">
<input onfocus="searchfield_focus(this)" type="search" class="search" name="q" value="Search Library">
<input type="hidden" name="sitesearch" value="">
</form>-->
</div>
<p><a href="index.html">Ohm Force Developer Library</a><a href="ohm.flip.guide.about.html">Flip Programming Guide</a></p>
</div>

<div id="toc">
<p>Flip Programming Guide</p>
<ul>
<li><a href="ohm.flip.guide.about.html">About Flip Programming Guide</a></li>
<li><a href="ohm.flip.guide.design.html">Designing your Flip Application</a></li>
<li><a href="ohm.flip.guide.class.html">Writing a Flip Class Part 1</a></li>
<li><a href="ohm.flip.guide.class2.html">Writing a Flip Class Part 2</a></li>
<li><a href="ohm.flip.guide.containers.html">Using Containers</a></li>
<li><a href="ohm.flip.guide.enums.html">Using Enums</a></li>
<li><a href="ohm.flip.guide.blob.html">Using Blobs</a></li>
<li><a href="ohm.flip.guide.objectref.html">Using ObjectRefs</a></li>
<li><a href="ohm.flip.guide.cue.html">Using Cues</a></li>
<li><a href="ohm.flip.guide.navigation.html">Navigating the Model</a></li>
<li><a href="ohm.flip.guide.observer.html">Writing a DocumentObserver</a></li>
<li><a href="ohm.flip.guide.validator.html">Writing a DocumentValidator</a></li>
<li><a href="ohm.flip.guide.undo.html">Using the Undo/Redo system</a></li>
<li><a href="ohm.flip.guide.const.html">Managing Pseudo Const Members</a></li>
<li><a href="ohm.flip.guide.mold.html">Using an ObjectMold</a></li>
<li><a href="ohm.flip.guide.conversion.html"><strong>Writing a Converter</strong></a>
	<ul>
	<li><a href="ohm.flip.guide.conversion.html#overview">Overview</a></li>
	<li><a href="ohm.flip.guide.conversion.html#tree">VersionTree</a></li>
	<li><a href="ohm.flip.guide.conversion.html#converter">Converter</a></li>
	</ul>
</li>
<li><a href="ohm.flip.guide.tweaker.html">Writing a DocumentTweaker</a></li>
</ul>

<div class="bottomspacer">&nbsp;</div>
</div>

<div id="content">

<div class="nav" align="right"><a href="ohm.flip.guide.mold.html">previous</a><span>&nbsp;</span><a href="ohm.flip.guide.tweaker.html">next</a></div>

<h1>Writing a Converter</h1>

<p>This chapter will describe how to convert a document when the model changes.
It will show all the classes that are used to do it.</p>
<h2><a name="overview">Overview</a></h2>
<p>The Flip framework integrates a powerful document conversion system. Conversion
occurs when the model changes, whatever the change. The model is associated a
new format version. Small changes are rather easy to convert with Flip, and
extreme model changes are equally easy as well to manage.</p>
<p>The format versions can be organised into a graph. Generally the graph is only
a simple chain, but it can be more complex, for example to handle A/B testing
on the model itself.</p>
<p>The code to convert to one format version to another is organized in the following
way :</p>
<ul>
<li>one function that handles the format version graph itself
</li>
<li>as many as functions as needed to convert from to adjacent format version
</li>
</ul>
<p>To illustrate the conversion process, we are going to use three models, respectively
format version
<span class="code">1</span> 
, format version
<span class="code">2</span> 
and format version
<span class="code">3</span> </p>
<div class="codeblock">
<p><strong>Listing</strong>Model format version
<span class="code">1</span> 
</p>
<table>
<tr><td><pre>class Root</pre></td></tr>
<tr><td><pre>:  public ohm::flip::Object</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>private:</pre></td></tr>
<tr><td><pre>   ohm::flip::Int64     _nbr_cats;</pre></td></tr>
<tr><td><pre>};</pre></td></tr>
</table>
</div>
<div class="codeblock">
<p><strong>Listing</strong>Model format version
<span class="code">2</span> 
</p>
<table>
<tr><td><small><pre>class Root</pre></small></td></tr>
<tr><td><small><pre>:  public ohm::flip::Object</pre></small></td></tr>
<tr><td><small><pre>{</pre></small></td></tr>
<tr><td><small><pre>private:</pre></small></td></tr>
<tr><td><small><pre>   ohm::flip::Int64     _nbr_cats;</pre></small></td></tr>
<tr><td><strong><pre>   ohm::flip::Int64     _nbr_dogs;</pre></strong></td></tr>
<tr><td><small><pre>};</pre></small></td></tr>
</table>
</div>
<div class="codeblock">
<p><strong>Listing</strong>Model format version
<span class="code">3</span> 
</p>
<table>
<tr><td><small><pre>class Root</pre></small></td></tr>
<tr><td><small><pre>:  public ohm::flip::Object</pre></small></td></tr>
<tr><td><small><pre>{</pre></small></td></tr>
<tr><td><small><pre>private:</pre></small></td></tr>
<tr><td><small><pre>   ohm::flip::Int64     _nbr_cats;</pre></small></td></tr>
<tr><td><small><pre>   ohm::flip::Int64     _nbr_dogs;</pre></small></td></tr>
<tr><td><strong><pre>   ohm::flip::Int64     _nbr_fishes;</pre></strong></td></tr>
<tr><td><small><pre>};</pre></small></td></tr>
</table>
</div>
<h2><a name="tree">VersionTree</a></h2>
<p>The first stage consists of making a function that will handle the conversion tree.
The conversion is going to be chained : each time a version converter will try to
upgrade the document to a more up-to-date version, until the current model format version
is reached.</p>
<p>The function itself must match the
<span class="code">ConverterProc</span> 
prototype as defined in
the
<span class="code">DocumentServer</span> 
class.</p>
<p>In our simple example, the function would look like below. It has been splitted
into two functions
<span class="code">convert</span> 
and
<span class="code">do_convert</span> 
for clarity.</p>
<div class="codeblock">
<table>
<tr><td><pre>int   convert (flip::DataStreamOutput & dst, flip::DataStreamInput & src, bool force_flag)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   int err = 0;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   flip::ConvDocument document;</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = document.read (src);</pre></td></tr>
<tr><td><pre>      assert (err == 0);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = do_convert (document);</pre></td></tr>
<tr><td><pre>      assert (err == 0);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = document.write (dst);</pre></td></tr>
<tr><td><pre>      assert (err == 0);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   return err;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<div class="codeblock">
<table>
<tr><td><pre>int   do_convert (flip::ConvDocument & document)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   int err = 0;</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   bool converted_flag = false;</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   try </pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      if ((err == 0) && (document._format_version == "1"))</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         Converter1_2 converter;</pre></td></tr>
<tr><td><pre>         </pre></td></tr>
<tr><td><pre>         err = converter.process (document);</pre></td></tr>
<tr><td><pre>         </pre></td></tr>
<tr><td><pre>         converted_flag = true;</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      if ((err == 0) && (document._format_version == "2"))</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         Converter2_3 converter;</pre></td></tr>
<tr><td><pre>         </pre></td></tr>
<tr><td><pre>         err = converter.process (document);</pre></td></tr>
<tr><td><pre>         </pre></td></tr>
<tr><td><pre>         converted_flag = true;</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>      if (converted_flag)</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         document._rev_id += 1;</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>   catch (...) </pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = flip::Err_EXCEPTION;</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   return err;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<p>In the code above, the
<span class="code">convert</span> 
prepare the work by loading the document in the
converter object then call the version tree handled by
<span class="code">do_convert</span> 
and finally
write the document back.</p>
<p>The document itself is loaded in a simple format : it does not need the current model
to be declared to be able to load. Classes, attributes are all referenced as simple
character strings that can be directly manipulated to ease the conversion process.</p>
<p>In the code above, the
<span class="code">do_convert</span> 
do the actual graph based conversion.
If the document is in format version
<span class="code">1</span> 
, it will first use a converter object
that will convert the document to version
<span class="code">2</span> 
. Then it will use another converter
object that will convert the document to version
<span class="code">3</span> 
.</p>
<p>Finally, if a conversion occured, the document revision id is incremented by one. This
is important for the Flip framework to know that this document has actually changed.</p>
<h2><a name="converter">Converter</a></h2>
<p>A canonical converter will convert from one specific format version to another
specific format version. The Flip framework offers a tool class,
<span class="code">ConvTools</span> 
that assists and ease the actual conversion process.</p>
<p>In the following listings, we are going to expose the converter from format
version
<span class="code">1</span> 
to format version
<span class="code">2</span> 
.</p>
<p>The first function is actually always the same : it just makes some checks to
ensure that every things is in a right state, and put back the document in
a correct state in the end (ensuring that Flip references do not collide).</p>
<div class="codeblock">
<table>
<tr><td><pre>int Converter1_2::process (flip::ConvDocument & document)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   int err = 0;</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      if (document._format_version != "1")</pre></td></tr>
<tr><td><pre>      {</pre></td></tr>
<tr><td><pre>         err = flip::Err_DOC_BAD_VERSION;</pre></td></tr>
<tr><td><pre>      }</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   flip::ConvObject & root = document._root;</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = ConvTools::check_recursive (root);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = convert_root (root);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      document.remap_refs ();</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      err = ConvTools::check_recursive (root);</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   if (err == 0)</pre></td></tr>
<tr><td><pre>   {</pre></td></tr>
<tr><td><pre>      document._format_version = "2";</pre></td></tr>
<tr><td><pre>   }</pre></td></tr>
<tr><td><pre></pre></td></tr>
<tr><td><pre>   return err;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<p>The second function is the actual conversion process</p>
<div class="codeblock">
<table>
<tr><td><pre>int Converter68679_69859::convert_root (flip::ConvObject & root)</pre></td></tr>
<tr><td><pre>{</pre></td></tr>
<tr><td><pre>   flip::ConvInt64 & nbr_dogs = ConvTools::add_attribute &lt;</pre></td></tr>
<tr><td><pre>      flip::ConvInt64</pre></td></tr>
<tr><td><pre>   &gt; (root, "_nbr_dogs");</pre></td></tr>
<tr><td><pre>   </pre></td></tr>
<tr><td><pre>   nbr_dogs._val = 4;</pre></td></tr>
<tr><td><pre>}</pre></td></tr>
</table>
</div>
<p>All the conversion tools are exposed in details in the
<a href="#ohm.flip.reference.conversion"></a></p>


<div class="nav" align="right"><a href="ohm.flip.guide.mold.html">previous</a><span>&nbsp;</span><a href="ohm.flip.guide.tweaker.html">next</a></div>

<div class="bottomspacer">&nbsp;</div>

</div>

<footer>
<a href="index.html">Ohm Force Developer Library</a> > <a href="ohm.flip.guide.about.html">Flip Programming Guide</a> > <a href="ohm.flip.guide.conversion.html">Writing a Converter</a>
</footer>


</body>

</html>